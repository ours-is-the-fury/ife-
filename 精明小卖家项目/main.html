<html>

<head>
    <meta charset="UTF-8">
    <title>IFE ECMAScript</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        #wrapper {
            width: 300px;
            height: 70px;
            padding: 20px 40px;
        }

        #tableWrapper {
            display: inline-block;
            width: 750px;
        }

        table {
            text-align: center;
            border: 2px solid #a1a1a1;
            padding: 10px 10px;
            background: #dddddd;
            width: 350px;
            border-radius: 25px;
        }

        table th {
            border: 1px solid #aaa;
            color: #fff;
            background-color: rgb(183, 178, 247);
            text-align: center;
            vertical-align: middle;
            letter-spacing: 1px;
        }

        table td {
            vertical-align: text-top;
            padding: 6px 15px 6px 6px;
            border: 1px solid #aaa;

        }

        table tr:nth-child(odd) {
            background-color: rgb(214, 214, 241);
        }

        table tr:nth-child(even) {
            background-color: rgb(162, 156, 247);
        }

        #region-radio-wrapper {
            font-size: 20px;
        }

        #product-radio-wrapper {
            font-size: 20px;
        }

        #graphs {
            position: absolute;
            width: 650px;
            left: 800px;
            top: 0px;
        }

        #bar-wrapper {
            display: inline-block;
        }

        #line-wrapper {
            display: inline-block;
        }
    </style>
</head>

<body>

    <div id="wrapper">
        <div id="region-radio-wrapper">
            <input type="checkbox" name="region" value="华东" checked="ture">华东
            <input type="checkbox" name="region" value="华南" checked="ture">华南
            <input type="checkbox" name="region" value="华北" checked="ture">华北
            <input type="checkbox" name="region" value="全选" checked="ture">全选
            <br/>
        </div>
        <div id="product-radio-wrapper">
            <input type="checkbox" name="product" value="手机" checked="ture">手机
            <input type="checkbox" name="product" value="笔记本" checked="ture">笔记本
            <input type="checkbox" name="product" value="智能音箱" checked="ture">智能音箱
            <input type="checkbox" name="product" value="全选" checked="ture">全选
        </div>
    </div>
    <div id="tableWrapper"></div>
    <div id="graphs">
        <div id="bar-wrapper">
            <svg id="svg" width='650' height='350' xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
        <div id="line-wrapper">
            <canvas id="canvas" width="650" height="350"></canvas>
        </div>
    </div>

    <script>

        //绘制柱状图
        function createBar(data) {
            // 绘制柱状图，参数data来自于invokeFn()的返回值，支持多数据
            let svg = document.getElementById('svg');
            svg.innerHTML = '';
            // 获取data中所有销量的最大值
            let arr = [];
            for (let i = 0; i < data.length; i++) {
                let per_max = Math.max.apply(null, data[i].sale);
                arr.push(per_max);
            };
            let all_max = Math.max.apply(null, arr);
            let t = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const axisY = 300;  // 代表Y轴的有效长度，不包含富余，下同
            const axisX = 600;
            let numY = 6;                       // 纵轴均分为6段
            let unitY_px = axisY / numY;        // 纵轴上，每段的像素长度(50px)
            let unitY_data = all_max / numY;    // 纵轴上，每段的数据长度
            let ratioY = axisY / all_max;       // 纵轴上，每单位数据的像素数
            let numX = 12;                      // 横轴均分为12段
            let unitX_px = axisX / numX;        // 横轴上，每刻度的像素长度(50px)
            // 绘制坐标轴：有效刻度 + 富余50
            let str_axisY = `<line x1='50' y1='350' x2='50' y2='50' stroke='#000' />`;
            let str_axisX = `<line x1='50' y1='350' x2='650' y2='350' stroke='#000' />`;
            // 绘制纵轴刻度 + 文字
            let str_scaleY = '';        // 将Y轴上的刻度，存储在一个字符串中
            let str_textY = '';         // 将Y轴上的文字，存储在一个字符串中
            for (let i = 1; i <= numY; i++) {
                let y = 350 - unitY_px * i;            // 每个Y轴刻度的纵坐标
                let tY = Math.round(unitY_data * i);   // 每个Y轴数字的值（取整）
                str_scaleY += `<line x1='50' y1='${y}' x2='45' y2='${y}' stroke='#000' />`;
                str_textY += `<text x='20' y='${y + 3}'>${tY}</text>`;    //  y+3：文字中心与刻度对齐
            };
            let strY = str_scaleY + str_textY + str_axisY;
            // 绘制纵轴刻度 + 文字
            let str_scaleX = '';
            let str_textX = '';
            for (let i = 0; i < 12; i++) {
                let x = 50 + unitX_px * i;        // 每个X轴刻度的横坐标
                str_scaleX += `<line x1='${x}' y1='350' x2='${x}' y2='345' stroke='#000' />`;
                str_textX += `<text x='${x + 16}' y='370'>${t[i]}</text>`;    // x+16：文字中心与每段中心对齐
            };
            let strX = str_scaleX + str_textX + str_axisX;
            // 绘制基线（与绘制纵轴刻度类似）
            let str_baseLine = '';
            for (let i = 1; i <= numY; i++) {
                let y = 350 - unitY_px * i;
                str_baseLine += `<line x1='50' y1='${y}' x2='650' y2='${y}' stroke='#ccc' />`;
            };
            // 绘制柱子
            let color = ["#60acfc", "#32d3eb", "#5bc49f", "#feb64d", "#ff7c7c", "#9287e7", "#60acfc", "#32d3eb", "#5bc49f"];  // 为各个柱子填充不同的颜色
            let len = data.length;
            let str_bar = '';
            let w = unitX_px / (len + 2);         // 柱子的宽度 = unitX_px / (柱子总数 + 2)
            for (let i = 0; i < len; i++) {
                let sale = data[i].sale;
                for (let j = 0; j < 12; j++) {
                    let x = 50 + unitX_px * j + w * i + w;              // 最后再加一个w：与每段中心对齐
                    let h = sale[j] * ratioY;                           // 每个柱子的像素高度
                    let y = 350 - h;                                    // 每个柱子左上角的纵坐标
                    str_bar += `<rect x='${x}' y='${y}' width='${w}' height='${h}' fill='${color[i]}' />`;
                }
            }
            svg.innerHTML = strY + strX + str_baseLine + str_bar;// 渲染所有图形元素
        }
        //创建折线图
        function createLine(data) {
            // 每次调用要先清空原图，重置画布
            let line_wrappper = document.getElementById('line-wrapper');
            line_wrappper.innerHTML = '';
            line_wrappper.innerHTML = `<canvas id="canvas" width="650" height="400"></canvas>`;
            // 获取data中所有销量的最大值
            let arr = [];
            for (let i = 0; i < data.length; i++) {
                let per_max = Math.max.apply(null, data[i].sale);
                arr.push(per_max);
            };
            let all_max = Math.max.apply(null, arr);
            let canvas = document.getElementById('canvas');
            let ctx = canvas.getContext('2d');
            let t = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const axisY = 300;                      // 代表Y轴的有效长度，不包含富余，下同
            const axisX = 600;
            let numY = 6;                           // 纵轴均分为6段
            let unitY_px = axisY / numY;            // 纵轴上，每段的像素长度(50px)
            let unitY_data = all_max / numY;        // 纵轴上，每段的数据长度
            let ratioY = axisY / all_max;           // 纵轴上，每单位数据的像素数
            let numX = 12;                          // 横轴均分为12段
            let unitX_px = axisX / numX;            // 横轴上，每刻度的像素长度(50px)
            // 绘制坐标轴：有效刻度 + 富余50
            ctx.beginPath();
            ctx.moveTo(50.5, 50.5);
            ctx.lineTo(50.5, 50.5 + axisY);
            ctx.lineTo(650.5, 50.5 + axisY);
            ctx.stroke();
            // 绘制纵轴刻度 + 文字
            for (let i = 1; i <= numY; i++) {
                let y = 350.5 - unitY_px * i;          // 每个Y轴刻度的纵坐标
                let tY = Math.round(unitY_data * i);   // 每个Y轴数字的值（取整）     
                // 刻度
                ctx.beginPath();
                ctx.moveTo(50.5, y);
                ctx.lineTo(45.5, y);
                ctx.stroke();
                // 文字
                ctx.fillText(`${tY}`, 20, y + 3);    //  y+3：文字中心与刻度对齐
            }
            // 绘制横轴刻度 + 文字
            for (let i = 0; i < 12; i++) {
                let x = 50.5 + unitX_px * i;        // 每个X轴刻度的横坐标
                // 刻度
                ctx.beginPath();
                ctx.moveTo(x, 350.5);
                ctx.lineTo(x, 345.5);
                ctx.stroke();
                ctx.fillText(t[i], x - 10, 370);       // x-10：文字中心与刻度对齐
            }
            // 绘制基线（与横轴重叠的不绘制）
            for (let i = 1; i <= numY; i++) {
                let y = 350.5 - unitY_px * i;
                ctx.beginPath();
                ctx.moveTo(50.5, y);
                ctx.lineTo(650.5, y);
                ctx.strokeStyle = '#ccc';
                ctx.stroke();
            }
            // 绘制数据点
            let color = ["#60acfc", "#32d3eb", "#5bc49f", "#feb64d", "#ff7c7c", "#9287e7", "#60acfc", "#32d3eb", "#5bc49f"];  // 为各个数据点、线条填充不同的颜色
            for (let i = 0; i < data.length; i++) {
                let sale = data[i].sale;
                for (let j = 0; j < 12; j++) {
                    let x = 50.5 + unitX_px * j;                    // 每个数据点的横坐标
                    let y = 350.5 - sale[j] * ratioY;               // 每个数据点的纵坐标
                    if (j == 0) {                                   // i为0时，第一个点，无需绘制线条
                        ctx.beginPath();
                        ctx.arc(x, y, 4, 0, 2 * Math.PI);
                        ctx.fillStyle = `${color[i]}`;
                        ctx.fill();
                    } else {
                        let x_pre = 50.5 + unitX_px * (j - 1);      // 上个数据点的横坐标
                        let y_pre = 350.5 - sale[j - 1] * ratioY;   // 上个数据点的纵坐标
                        ctx.beginPath();
                        ctx.arc(x, y, 4, 0, 2 * Math.PI);
                        ctx.moveTo(x, y);
                        ctx.lineTo(x_pre, y_pre);
                        ctx.fillStyle = `${color[i]}`;
                        ctx.strokeStyle = `${color[i]}`;
                        ctx.fill();
                        ctx.stroke();
                    }
                }
            }
        }

        var region = document.getElementsByName("region");
        var product = document.getElementsByName("product");
        var regionCheck = document.querySelector("#region-radio-wrapper");
        var productCheck = document.querySelector("#product-radio-wrapper");
        //根据被选中的商品和地区，获取数据
        function findData() {
            var data = new Array();
            for (var i = 0; i < region.length; i++) {
                if (region[i].checked == true) {
                    data.push(region[i].value);
                }
            }
            for (var i = 0; i < product.length; i++) {
                if (product[i].checked == true) {
                    data.push(product[i].value);
                }
            }
            var getData = new Array();
            for (var i = 0; i < sourceData.length; i++) {
                if (data.indexOf(sourceData[i].product) != -1 && data.indexOf(sourceData[i].region) != -1) {
                    getData.push(sourceData[i]);
                }
            }
            return getData;
        }
        //检查勾选状态函数  wrapper 选择类型（地区或者商品），event为触发事件
        function checkType(wrapper, event) {
            var type = event.target.value
            if (type == "全选") {                       //点击的是全选，进行全选操作或者无反应               
                event.target.checked = "ture";
                for (var i = 0; i < 3; i++) {
                    wrapper[i].checked = "ture";
                }
            }
            else {											//点击的是其它选项
                var flag = 0;
                for (var i = 0; i < 3; i++) {
                    if (wrapper[i].value != type) {
                        if (wrapper[i].checked == true) flag++;
                    }
                }
                if (flag == (wrapper.length - 2) && event.target.checked == true) {	//点击之后满足全选状态
                    wrapper[3].checked = "ture";
                }
                if (flag == (wrapper.length - 2) && event.target.checked == false) {	//当全选时，取消其中一个选项
                    wrapper[3].checked = "";
                }
                if (flag == 0 && event.target.checked == false) {	//点击的是唯一已勾选的，不允许一个都不选
                    event.target.checked = "ture";
                }
            }
        }

        let tableWrapper = document.querySelector("#tableWrapper");
        let table = document.createElement("table");
        table.setAttribute("id", "table");
        //创建表格
        function createTable(getData) {
            table.innerHTML = "";
            let tr = document.createElement("tr");
            tr.innerHTML = `
        <th>商品</th>
        <th>地区</th>
        <th>1月</th>
        <th>2月</th>
        <th>3月</th>
        <th>4月</th>
        <th>5月</th>
        <th>6月</th>
        <th>7月</th>
        <th>8月</th>
        <th>9月</th>
        <th>10月</th>
        <th>12月</th>
        <th>12月</th>
    `;
            table.appendChild(tr);
            tableWrapper.appendChild(table);
            for (let i = 0; i < getData.length; i++) {          // 遍历拿到的数据数组getData
                let tr = document.createElement("tr");
                for (let key in getData[i]) {                   // 遍历数组中每一个对象
                    if (getData[i].hasOwnProperty(key)) {
                        if (!Array.isArray(getData[i][key])) {  // 判断getData[i]的value是否是数组，非数组则直接添加到td里
                            let td = document.createElement("td");
                            td.innerHTML = getData[i][key];
                            tr.appendChild(td);
                        } else {
                            for (let k = 0; k < getData[i][key].length; k++) {// 如果是数组，则遍历数组，将数组中的每一项分别创建并添加到td
                                let td = document.createElement("td");
                                td.innerHTML = getData[i][key][k];
                                tr.appendChild(td);
                            }
                        }
                    }
                }
                table.appendChild(tr);
            }
            tableWrapper.appendChild(table);
        }
        //交换第一列第二列顺序
        function changeTd() {
            let ipts1 = regionCheck.querySelectorAll("input[type=checkbox]:checked");
            let ipts2 = productCheck.querySelectorAll("input[type=checkbox]:checked");
            let tab = document.querySelector("#table");
            if (ipts1.length == 1 && ipts2.length != 1) {// 当地区选择了一个，商品选择了多个的时候，第一列第二列交换
                for (let i = 0; i < tab.rows.length; i++) {
                    let temp = tab.rows[i].cells[0].innerHTML;
                    tab.rows[i].cells[0].innerHTML = tab.rows[i].cells[1].innerHTML;
                    tab.rows[i].cells[1].innerHTML = temp;
                }
            }
        }
        //合并重复单元
        function mergeCell(startrow, col) {
            let tab = document.querySelector("#table");
            for (let i = startrow; i < tab.rows.length - 1; i++) {
                if (tab.rows[startrow].cells[col].innerHTML === tab.rows[i + 1].cells[col].innerHTML) {// 如果第i行和第i+1行内容相同则隐藏第i+1行，同时第i行的rowSpan+1
                    tab.rows[i + 1].cells[col].style.display = "none";
                    tab.rows[startrow].cells[col].rowSpan += 1;
                }
                else {
                    mergeCell(i + 1, 0) // 不相等的时候从第i+1行再次执行次函数
                }
            }
        }
        //原始数据
        let sourceData = [{
            product: "手机",
            region: "华东",
            sale: [120, 100, 140, 160, 180, 185, 190, 210, 230, 245, 255, 270]
        }, {
            product: "手机",
            region: "华北",
            sale: [80, 70, 90, 110, 130, 145, 150, 160, 170, 185, 190, 200]
        }, {
            product: "手机",
            region: "华南",
            sale: [220, 200, 240, 250, 260, 270, 280, 295, 310, 335, 355, 380]
        }, {
            product: "笔记本",
            region: "华东",
            sale: [50, 60, 80, 110, 30, 20, 70, 30, 420, 30, 20, 20]
        }, {
            product: "笔记本",
            region: "华北",
            sale: [30, 35, 50, 70, 20, 15, 30, 50, 710, 130, 20, 20]
        }, {
            product: "笔记本",
            region: "华南",
            sale: [80, 120, 130, 140, 70, 75, 120, 90, 550, 120, 110, 100]
        }, {
            product: "智能音箱",
            region: "华东",
            sale: [10, 30, 4, 5, 6, 5, 4, 5, 6, 5, 5, 25]
        }, {
            product: "智能音箱",
            region: "华北",
            sale: [15, 50, 15, 15, 12, 11, 11, 12, 12, 14, 12, 40]
        }, {
            product: "智能音箱",
            region: "华南",
            sale: [10, 40, 10, 6, 5, 6, 8, 6, 6, 6, 7, 26]
        }]
        //初始化
        createTable(findData())
        createLine(findData())
        createBar(findData())
        changeTd()
        mergeCell(1, 0)


        //事件响应
        regionCheck.onclick = function (event) {
            checkType(region, event);
            createTable(findData())
            createLine(findData())
            createBar(findData())
            changeTd()
            mergeCell(1, 0)
        }

        productCheck.onclick = function (event) {
            checkType(product, event);
            createTable(findData())
            createLine(findData())
            createBar(findData())
            changeTd()
            mergeCell(1, 0)
        }
        //鼠标悬浮制作图标
        table.onmouseover = function (event) {
            let tar = event.target
            if (tar.nodeName.toLowerCase() === 'td') {
                let tr = tar.parentNode;
                tr.style.color = "yellow";
                let tdList = tr.childNodes;
                let arr = [];
                for (let i = 2; i < tdList.length; i++) {
                    arr.push(Number(tdList[i].textContent));
                }
                let getData = [{
                    product: 'abather',//内容无关图表的制作任意设置
                    region: 'abather',//内容无关
                    sale: arr//
                }]
                //console.log(arr)
                createBar(getData);
                createLine(getData);
            }
        }
        //鼠标离开重新作出已选选项图表
        table.onmouseout = function (event) {
            let tar = event.target

            let tr = tar.parentNode;
            tr.style.color = "black";
            let oldData = findData();
            createBar(oldData);
            createLine(oldData);
        }
    </script>
</body>

</html>